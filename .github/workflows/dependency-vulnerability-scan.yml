name: Dependency Vulnerability Scan

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1' # 매주 월요일 11:00 KST
  push:
    branches:
      - main

jobs:
  audit:
    name: pnpm Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        run: |
          echo "Running pnpm audit with JSON output..."

          # Create centralized reports directory
          mkdir -p reports/audit

          pnpm audit --audit-level=low --json > reports/audit/dependency-audit.json || true

          if [ ! -s reports/audit/dependency-audit.json ]; then
            echo "pnpm audit did not produce output."
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "moderate=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "should_fail=false" >> $GITHUB_OUTPUT
            echo "has_warnings=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse vulnerability counts from pnpm audit v9 format
          # pnpm v9 returns vulnerabilities in this format:
          # { "vulnerabilities": { "critical": 0, "high": 1, "moderate": 2, "low": 0 } }
          critical=0
          high=0
          moderate=0
          low=0

          if jq -e '.vulnerabilities' reports/audit/dependency-audit.json > /dev/null 2>&1; then
            critical=$(jq -r '.vulnerabilities.critical // 0' reports/audit/dependency-audit.json)
            high=$(jq -r '.vulnerabilities.high // 0' reports/audit/dependency-audit.json)
            moderate=$(jq -r '.vulnerabilities.moderate // 0' reports/audit/dependency-audit.json)
            low=$(jq -r '.vulnerabilities.low // 0' reports/audit/dependency-audit.json)
          fi

          echo "Vulnerability counts: critical=$critical, high=$high, moderate=$moderate, low=$low"

          echo "critical=$critical" >> $GITHUB_OUTPUT
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "moderate=$moderate" >> $GITHUB_OUTPUT
          echo "low=$low" >> $GITHUB_OUTPUT

          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
            should_fail=true
          else
            should_fail=false
          fi

          if [ "$moderate" -gt 0 ] || [ "$low" -gt 0 ]; then
            has_warnings=true
          else
            has_warnings=false
          fi

          echo "should_fail=$should_fail" >> $GITHUB_OUTPUT
          echo "has_warnings=$has_warnings" >> $GITHUB_OUTPUT

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: reports/audit/
          if-no-files-found: warn

      - name: Summarize audit findings
        if: always()
        env:
          CRITICAL: ${{ steps.audit.outputs.critical }}
          HIGH: ${{ steps.audit.outputs.high }}
          MODERATE: ${{ steps.audit.outputs.moderate }}
          LOW: ${{ steps.audit.outputs.low }}
          HAS_WARNINGS: ${{ steps.audit.outputs.has_warnings }}
        run: |
          echo "## Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: ${CRITICAL:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- High: ${HIGH:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Moderate: ${MODERATE:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- Low: ${LOW:-0}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${CRITICAL:-0}" -gt 0 ] || [ "${HIGH:-0}" -gt 0 ]; then
            echo "⚠️ **Critical/High vulnerabilities detected.**" >> $GITHUB_STEP_SUMMARY
            echo "  - Run \`pnpm audit --audit-level high\` locally to inspect details." >> $GITHUB_STEP_SUMMARY
          elif [ "${HAS_WARNINGS}" = "true" ]; then
            echo "⚠️ **Moderate/Low vulnerabilities detected.** (workflow continues)" >> $GITHUB_STEP_SUMMARY
            echo "  - Review the attached \`dependency-audit.json\` artifact." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No known vulnerabilities detected at this time." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on critical or high vulnerabilities
        if: steps.audit.outputs.should_fail == 'true'
        run: |
          echo "Critical or high severity vulnerabilities detected. Failing job."
          exit 1
