name: Auto Add Jira Key to PR Title

on:
  pull_request:
    types: [opened, edited]

jobs:
  add-jira-key:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Jira Key from Branch and Update PR Title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = context.payload.pull_request.head.ref;
            const currentTitle = context.payload.pull_request.title;

            console.log(`PR #${prNumber}`);
            console.log(`Branch: ${branchName}`);
            console.log(`Current Title: ${currentTitle}`);

            // Jira í‚¤ íŒ¨í„´ ë§¤ì¹­ (ì˜ˆ: JST-123, PROJ-456)
            // ë¸Œëœì¹˜ëª…ì—ì„œ ì¶”ì¶œ: feature/JST-123-description ë˜ëŠ” JST-123-fix-bug
            const jiraKeyPattern = /([A-Z]+-\d+)/;
            const match = branchName.match(jiraKeyPattern);

            if (!match) {
              console.log('âš ï¸  ë¸Œëœì¹˜ëª…ì—ì„œ Jira í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              console.log('ì˜ˆìƒ í˜•ì‹: feature/JST-123-description ë˜ëŠ” JST-123-fix-bug');
              return;
            }

            const jiraKey = match[1];
            console.log(`âœ“ ì¶”ì¶œëœ Jira í‚¤: ${jiraKey}`);

            // ì´ë¯¸ ì œëª©ì— Jira í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (currentTitle.includes(`[${jiraKey}]`)) {
              console.log('âœ“ PR ì œëª©ì— ì´ë¯¸ Jira í‚¤ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
              return;
            }

            // Jira í‚¤ë¥¼ ì œëª© ì•ì— ì¶”ê°€
            const newTitle = `[${jiraKey}] ${currentTitle}`;

            console.log(`ìƒˆ ì œëª©: ${newTitle}`);

            // PR ì œëª© ì—…ë°ì´íŠ¸
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              title: newTitle
            });

            console.log('âœ… PR ì œëª©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');

            // ì„±ê³µ ë©”ì‹œì§€ ì½”ë©˜íŠ¸ ì¶”ê°€
            const jiraHost = process.env.JIRA_HOST || 'your-domain.atlassian.net';
            const commentBody = "ğŸ”— **Jira í‚¤ ìë™ ì¶”ê°€ ì™„ë£Œ**\n\n" +
              "**Jira Issue:** [" + jiraKey + "](https://" + jiraHost + "/browse/" + jiraKey + ")\n\n" +
              "> PR ì œëª©ì´ `[" + jiraKey + "]` ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
        env:
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
