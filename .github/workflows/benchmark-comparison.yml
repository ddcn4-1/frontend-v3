name: Multi Benchmark Comparison

on:
  workflow_dispatch:
    inputs:
      configurations:
        description: 'Benchmark configurations to run'
        type: choice
        options:
          - 'all'           # baseline, turbo, parallel, all-opts
          - 'cache-only'    # baseline vs turbo-cache
          - 'build-only'    # baseline vs parallel-builds
        default: 'all'
      run_count:
        description: 'Number of runs per configuration'
        required: false
        default: '3'

# Prevent concurrent benchmark runs to ensure accurate measurements
concurrency:
  group: benchmark-comparison-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: ap-northeast-2
  CLIENT_BUCKET_NAME: ${{ vars.CLIENT_BUCKET_NAME }}
  ADMIN_BUCKET_NAME: ${{ vars.ADMIN_BUCKET_NAME }}
  ACCOUNTS_BUCKET_NAME: ${{ vars.ACCOUNTS_BUCKET_NAME }}

permissions:
  contents: write
  id-token: write

jobs:
  setup-matrix:
    name: Setup Benchmark Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      timestamp: ${{ steps.set-matrix.outputs.timestamp }}
    steps:
      - name: Determine benchmark configurations
        id: set-matrix
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"

          if [ "${{ github.event.inputs.configurations }}" = "all" ]; then
            MATRIX='{"include":[{"name":"baseline","pnpm_cache":false,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"with-pnpm-cache","pnpm_cache":true,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"with-turbo-cache","pnpm_cache":true,"turbo_cache":true,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"with-s3-apne2","pnpm_cache":true,"turbo_cache":false,"s3_remote":true,"s3_region":"ap-northeast-2","parallel_build":false},{"name":"with-s3-usea1","pnpm_cache":true,"turbo_cache":false,"s3_remote":true,"s3_region":"us-east-1","parallel_build":false},{"name":"parallel-builds","pnpm_cache":true,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":true},{"name":"all-optimizations","pnpm_cache":true,"turbo_cache":true,"s3_remote":false,"s3_region":"","parallel_build":true},{"name":"all-with-s3-apne2","pnpm_cache":true,"turbo_cache":false,"s3_remote":true,"s3_region":"ap-northeast-2","parallel_build":true}]}'
          elif [ "${{ github.event.inputs.configurations }}" = "cache-only" ]; then
            MATRIX='{"include":[{"name":"baseline","pnpm_cache":false,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"with-pnpm-cache","pnpm_cache":true,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"with-turbo-cache","pnpm_cache":true,"turbo_cache":true,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"with-s3-apne2","pnpm_cache":true,"turbo_cache":false,"s3_remote":true,"s3_region":"ap-northeast-2","parallel_build":false},{"name":"with-s3-usea1","pnpm_cache":true,"turbo_cache":false,"s3_remote":true,"s3_region":"us-east-1","parallel_build":false}]}'
          else
            MATRIX='{"include":[{"name":"baseline","pnpm_cache":false,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":false},{"name":"parallel-builds","pnpm_cache":true,"turbo_cache":false,"s3_remote":false,"s3_region":"","parallel_build":true}]}'
          fi

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          # üìä Multi Benchmark Comparison

          <details>
          <summary>‚öôÔ∏è Configuration Details</summary>

          - **Configuration Set**: \`${{ github.event.inputs.configurations }}\`
          - **Runs per Configuration**: ${{ github.event.inputs.run_count }}
          - **Timestamp**: \`$TIMESTAMP\`
          - **Branch**: \`${{ github.ref_name }}\`
          - **Commit**: \`${{ github.sha }}\`
          - **Runner**: \`ubuntu-latest\`
          - **Node.js**: \`22\`
          - **pnpm**: \`9.15.0\`

          </details>
          EOF

  run-benchmarks:
    name: Benchmark - ${{ matrix.name }}
    runs-on: ubuntu-latest
    needs: setup-matrix
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Record start time and collect runner specs
        id: start
        run: |
          START_TIME=$(date +%s%3N)
          echo "start_time=$START_TIME" >> "$GITHUB_OUTPUT"
          echo "Start: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # Collect runner specifications
          echo "cpu_cores=$(nproc)" >> "$GITHUB_OUTPUT"
          echo "total_memory=$(free -h | awk '/^Mem:/ {print $2}')" >> "$GITHUB_OUTPUT"
          echo "available_memory=$(free -h | awk '/^Mem:/ {print $7}')" >> "$GITHUB_OUTPUT"
          echo "cpu_model=$(lscpu | grep 'Model name:' | cut -d: -f2 | xargs)" >> "$GITHUB_OUTPUT"
          echo "disk_space=$(df -h / | awk 'NR==2 {print $4}')" >> "$GITHUB_OUTPUT"

      - name: Checkout
        id: checkout
        run: echo "step_start=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4

      - name: Record checkout time
        id: checkout_end
        run: |
          STEP_END=$(date +%s%3N)
          CHECKOUT_TIME_MS=$((STEP_END - ${{ steps.checkout.outputs.step_start }}))
          CHECKOUT_TIME=$(printf "%.2f" $(echo "scale=2; $CHECKOUT_TIME_MS / 1000" | bc))
          echo "checkout_duration=$CHECKOUT_TIME" >> "$GITHUB_OUTPUT"
          echo "Checkout: ${CHECKOUT_TIME}s"

      - name: Install pnpm (Start)
        id: pnpm_start
        run: echo "step_start=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - name: Record pnpm install time
        id: pnpm_end
        run: |
          STEP_END=$(date +%s%3N)
          PNPM_TIME_MS=$((STEP_END - ${{ steps.pnpm_start.outputs.step_start }}))
          PNPM_TIME=$(printf "%.2f" $(echo "scale=2; $PNPM_TIME_MS / 1000" | bc))
          echo "pnpm_duration=$PNPM_TIME" >> "$GITHUB_OUTPUT"
          echo "pnpm setup: ${PNPM_TIME}s"

      - name: Setup Node.js (Start)
        id: node_start
        run: echo "step_start=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ matrix.pnpm_cache && 'pnpm' || '' }}

      - name: Record Node.js setup time
        id: node_end
        run: |
          STEP_END=$(date +%s%3N)
          NODE_TIME_MS=$((STEP_END - ${{ steps.node_start.outputs.step_start }}))
          NODE_TIME=$(echo "scale=2; $NODE_TIME_MS / 1000" | bc)
          echo "node_duration=$NODE_TIME" >> "$GITHUB_OUTPUT"
          echo "Node.js setup: ${NODE_TIME}s"

      - name: Install dependencies (Start)
        id: deps_start
        run: echo "step_start=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Record dependencies install time
        id: deps_end
        run: |
          STEP_END=$(date +%s%3N)
          DEPS_TIME_MS=$((STEP_END - ${{ steps.deps_start.outputs.step_start }}))
          DEPS_TIME=$(echo "scale=2; $DEPS_TIME_MS / 1000" | bc)
          echo "deps_duration=$DEPS_TIME" >> "$GITHUB_OUTPUT"
          echo "Dependencies: ${DEPS_TIME}s"

      # Turbo cache configuration
      - name: Setup Turbo local cache
        if: matrix.turbo_cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Setup S3 remote cache
        if: matrix.s3_remote
        run: |
          # Configure S3 cache bucket
          CACHE_BUCKET="turbo-cache-${{ matrix.s3_region }}"

          # Start custom S3 cache server in background
          # Note: @aws-sdk/client-s3 is already installed in devDependencies
          PORT=8080 \
          AWS_REGION=${{ matrix.s3_region }} \
          S3_BUCKET=$CACHE_BUCKET \
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
          node scripts/turbo-s3-cache-server.js > turbo-cache-server.log 2>&1 &

          CACHE_PID=$!
          echo "cache_server_pid=$CACHE_PID" >> "$GITHUB_ENV"

          # Wait for server to start
          sleep 3

          # Test server is responding
          curl -f http://localhost:8080/v8/artifacts/status || (cat turbo-cache-server.log && exit 1)

          # Configure Turbo to use our cache server
          echo "TURBO_API=http://localhost:8080" >> "$GITHUB_ENV"
          echo "TURBO_TOKEN=no-token" >> "$GITHUB_ENV"
          echo "TURBO_TEAM=no-team" >> "$GITHUB_ENV"

          echo "‚úÖ S3 remote cache enabled (Region: ${{ matrix.s3_region }}, Bucket: $CACHE_BUCKET)"
          cat turbo-cache-server.log

      # Sequential builds
      - name: Build all apps (Sequential)
        if: ${{ !matrix.parallel_build }}
        run: |
          # Client
          CLIENT_START=$(date +%s%3N)
          pnpm run build --filter=@apps/client
          CLIENT_END=$(date +%s%3N)
          CLIENT_TIME_MS=$((CLIENT_END - CLIENT_START))
          CLIENT_TIME=$(echo "scale=2; $CLIENT_TIME_MS / 1000" | bc)
          echo "client_duration=$CLIENT_TIME" >> "$GITHUB_ENV"

          # Admin
          ADMIN_START=$(date +%s%3N)
          pnpm run build --filter=@apps/admin
          ADMIN_END=$(date +%s%3N)
          ADMIN_TIME_MS=$((ADMIN_END - ADMIN_START))
          ADMIN_TIME=$(echo "scale=2; $ADMIN_TIME_MS / 1000" | bc)
          echo "admin_duration=$ADMIN_TIME" >> "$GITHUB_ENV"

          # Accounts
          ACCOUNTS_START=$(date +%s%3N)
          pnpm run build --filter=@apps/accounts
          ACCOUNTS_END=$(date +%s%3N)
          ACCOUNTS_TIME_MS=$((ACCOUNTS_END - ACCOUNTS_START))
          ACCOUNTS_TIME=$(echo "scale=2; $ACCOUNTS_TIME_MS / 1000" | bc)
          echo "accounts_duration=$ACCOUNTS_TIME" >> "$GITHUB_ENV"

          echo "Client: ${CLIENT_TIME}s, Admin: ${ADMIN_TIME}s, Accounts: ${ACCOUNTS_TIME}s"

      # Parallel builds
      - name: Build all apps (Parallel)
        if: matrix.parallel_build
        run: |
          BUILD_START=$(date +%s%3N)

          # Start all builds in parallel with time tracking
          (time pnpm run build --filter=@apps/client 2>&1) > client_build.log 2>&1 &
          CLIENT_PID=$!

          (time pnpm run build --filter=@apps/admin 2>&1) > admin_build.log 2>&1 &
          ADMIN_PID=$!

          (time pnpm run build --filter=@apps/accounts 2>&1) > accounts_build.log 2>&1 &
          ACCOUNTS_PID=$!

          # Wait for all to complete and get exit codes
          wait $CLIENT_PID
          CLIENT_EXIT=$?

          wait $ADMIN_PID
          ADMIN_EXIT=$?

          wait $ACCOUNTS_PID
          ACCOUNTS_EXIT=$?

          BUILD_END=$(date +%s%3N)
          TOTAL_PARALLEL_TIME_MS=$((BUILD_END - BUILD_START))
          TOTAL_PARALLEL_TIME=$(echo "scale=2; $TOTAL_PARALLEL_TIME_MS / 1000" | bc)

          # For parallel builds, total time is the longest running build
          # Individual times are approximations since they run concurrently
          echo "client_duration=$TOTAL_PARALLEL_TIME" >> "$GITHUB_ENV"
          echo "admin_duration=$TOTAL_PARALLEL_TIME" >> "$GITHUB_ENV"
          echo "accounts_duration=$TOTAL_PARALLEL_TIME" >> "$GITHUB_ENV"

          # Check all succeeded
          if [ $CLIENT_EXIT -ne 0 ] || [ $ADMIN_EXIT -ne 0 ] || [ $ACCOUNTS_EXIT -ne 0 ]; then
            echo "One or more builds failed"
            cat client_build.log admin_build.log accounts_build.log
            exit 1
          fi

          echo "Parallel build completed in ${TOTAL_PARALLEL_TIME}s"

      - name: Record build times
        id: build_end
        run: |
          CLIENT_TIME=${client_duration}
          ADMIN_TIME=${admin_duration}
          ACCOUNTS_TIME=${accounts_duration}

          # For sequential builds: sum all times
          # For parallel builds: use the total (already the max time)
          if [ "${{ matrix.parallel_build }}" = "true" ]; then
            # Parallel: all three times are the same (total parallel time)
            BUILD_TOTAL=$CLIENT_TIME
          else
            # Sequential: sum individual times
            BUILD_TOTAL=$(echo "scale=2; $CLIENT_TIME + $ADMIN_TIME + $ACCOUNTS_TIME" | bc)
          fi

          echo "client_duration=$CLIENT_TIME" >> "$GITHUB_OUTPUT"
          echo "admin_duration=$ADMIN_TIME" >> "$GITHUB_OUTPUT"
          echo "accounts_duration=$ACCOUNTS_TIME" >> "$GITHUB_OUTPUT"
          echo "build_total=$BUILD_TOTAL" >> "$GITHUB_OUTPUT"

      - name: Calculate total time and generate report
        id: summary
        run: |
          END_TIME=$(date +%s%3N)
          TOTAL_TIME_MS=$((END_TIME - ${{ steps.start.outputs.start_time }}))
          TOTAL_TIME=$(echo "scale=2; $TOTAL_TIME_MS / 1000" | bc)

          CHECKOUT_TIME=${{ steps.checkout_end.outputs.checkout_duration }}
          PNPM_TIME=${{ steps.pnpm_end.outputs.pnpm_duration }}
          NODE_TIME=${{ steps.node_end.outputs.node_duration }}
          DEPS_TIME=${{ steps.deps_end.outputs.deps_duration }}
          CLIENT_TIME=${{ steps.build_end.outputs.client_duration }}
          ADMIN_TIME=${{ steps.build_end.outputs.admin_duration }}
          ACCOUNTS_TIME=${{ steps.build_end.outputs.accounts_duration }}
          BUILD_TOTAL=${{ steps.build_end.outputs.build_total }}
          SETUP_TOTAL=$(echo "scale=2; $CHECKOUT_TIME + $PNPM_TIME + $NODE_TIME + $DEPS_TIME" | bc)

          echo "total_duration=$TOTAL_TIME" >> "$GITHUB_OUTPUT"
          echo "setup_total=$SETUP_TOTAL" >> "$GITHUB_OUTPUT"
          echo "build_total=$BUILD_TOTAL" >> "$GITHUB_OUTPUT"

          # Determine configuration icons
          PNPM_ICON=${{ matrix.pnpm_cache && '‚úÖ' || '‚ùå' }}
          TURBO_ICON=${{ matrix.turbo_cache && '‚úÖ' || '‚ùå' }}
          S3_ICON=${{ matrix.s3_remote && '‚úÖ' || '‚ùå' }}
          PARALLEL_ICON=${{ matrix.parallel_build && '‚úÖ' || '‚ùå' }}

          # S3 Region display
          S3_REGION="${{ matrix.s3_region }}"
          if [ -n "$S3_REGION" ]; then
            S3_DISPLAY="${S3_ICON} ($S3_REGION)"
          else
            S3_DISPLAY="${S3_ICON}"
          fi

          # Calculate percentages
          CHECKOUT_PCT=$(echo "scale=1; ($CHECKOUT_TIME / $TOTAL_TIME) * 100" | bc)
          PNPM_PCT=$(echo "scale=1; ($PNPM_TIME / $TOTAL_TIME) * 100" | bc)
          NODE_PCT=$(echo "scale=1; ($NODE_TIME / $TOTAL_TIME) * 100" | bc)
          DEPS_PCT=$(echo "scale=1; ($DEPS_TIME / $TOTAL_TIME) * 100" | bc)
          SETUP_PCT=$(echo "scale=1; ($SETUP_TOTAL / $TOTAL_TIME) * 100" | bc)
          CLIENT_PCT=$(echo "scale=1; ($CLIENT_TIME / $TOTAL_TIME) * 100" | bc)
          ADMIN_PCT=$(echo "scale=1; ($ADMIN_TIME / $TOTAL_TIME) * 100" | bc)
          ACCOUNTS_PCT=$(echo "scale=1; ($ACCOUNTS_TIME / $TOTAL_TIME) * 100" | bc)
          BUILD_PCT=$(echo "scale=1; ($BUILD_TOTAL / $TOTAL_TIME) * 100" | bc)

          cat >> "$GITHUB_STEP_SUMMARY" << EOF

          ---

          ## üì¶ ${{ matrix.name }}

          **Configuration:**
          - pnpm Cache: ${PNPM_ICON}
          - Turbo Local Cache: ${TURBO_ICON}
          - S3 Remote Cache: ${S3_DISPLAY}
          - Parallel Build: ${PARALLEL_ICON}

          ### ‚è±Ô∏è Performance Breakdown

          | Phase | Duration | Percentage |
          |-------|----------|------------|
          | üîÑ Checkout | ${CHECKOUT_TIME}s | ${CHECKOUT_PCT}% |
          | üì¶ pnpm Setup | ${PNPM_TIME}s | ${PNPM_PCT}% |
          | ‚öôÔ∏è Node.js Setup | ${NODE_TIME}s | ${NODE_PCT}% |
          | üì• Dependencies | ${DEPS_TIME}s | ${DEPS_PCT}% |
          | **üîß Setup Total** | **${SETUP_TOTAL}s** | **${SETUP_PCT}%** |
          | üåê Client Build | ${CLIENT_TIME}s | ${CLIENT_PCT}% |
          | üë§ Admin Build | ${ADMIN_TIME}s | ${ADMIN_PCT}% |
          | üîë Accounts Build | ${ACCOUNTS_TIME}s | ${ACCOUNTS_PCT}% |
          | **üèóÔ∏è Build Total** | **${BUILD_TOTAL}s** | **${BUILD_PCT}%** |
          | **‚ö° TOTAL** | **${TOTAL_TIME}s** | **100%** |

          EOF

      - name: Save benchmark data
        run: |
          mkdir -p benchmark-results
          cat > benchmark-results/${{ matrix.name }}.json << EOF
          {
            "benchmark_id": "${{ matrix.name }}-${{ needs.setup-matrix.outputs.timestamp }}",
            "benchmark_name": "${{ matrix.name }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "configuration": {
              "pnpm_cache": ${{ matrix.pnpm_cache }},
              "turbo_cache": ${{ matrix.turbo_cache }},
              "s3_remote": ${{ matrix.s3_remote }},
              "s3_region": "${{ matrix.s3_region }}",
              "parallel_build": ${{ matrix.parallel_build }}
            },
            "runner": {
              "os": "ubuntu-latest",
              "node_version": "22",
              "pnpm_version": "9.15.0",
              "cpu_cores": "${{ steps.start.outputs.cpu_cores }}",
              "cpu_model": "${{ steps.start.outputs.cpu_model }}",
              "total_memory": "${{ steps.start.outputs.total_memory }}",
              "available_memory": "${{ steps.start.outputs.available_memory }}",
              "disk_space": "${{ steps.start.outputs.disk_space }}"
            },
            "timings": {
              "checkout": ${{ steps.checkout_end.outputs.checkout_duration }},
              "pnpm_setup": ${{ steps.pnpm_end.outputs.pnpm_duration }},
              "node_setup": ${{ steps.node_end.outputs.node_duration }},
              "dependencies": ${{ steps.deps_end.outputs.deps_duration }},
              "setup_total": ${{ steps.summary.outputs.setup_total }},
              "client_build": ${{ steps.build_end.outputs.client_duration }},
              "admin_build": ${{ steps.build_end.outputs.admin_duration }},
              "accounts_build": ${{ steps.build_end.outputs.accounts_duration }},
              "build_total": ${{ steps.summary.outputs.build_total }},
              "total": ${{ steps.summary.outputs.total_duration }}
            },
            "git_sha": "${{ github.sha }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Upload benchmark data
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.name }}
          path: benchmark-results/
          retention-days: 90

  compare-results:
    name: Compare All Results
    runs-on: ubuntu-latest
    needs: [setup-matrix, run-benchmarks]
    steps:
      - name: Download all benchmark results
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Combine and analyze results
        id: analyze
        run: |
          # Combine all results
          mkdir -p combined
          find all-results -name "*.json" -type f -exec cp {} combined/ \;

          # Create comparison report and extract runner specs from first result
          FIRST_FILE=$(find combined -name "*.json" -type f | head -1)
          CPU_CORES=$(jq -r '.runner.cpu_cores' "$FIRST_FILE")
          CPU_MODEL=$(jq -r '.runner.cpu_model' "$FIRST_FILE")
          TOTAL_MEM=$(jq -r '.runner.total_memory' "$FIRST_FILE")
          DISK_SPACE=$(jq -r '.runner.disk_space' "$FIRST_FILE")

          cat > comparison-report.md << EOF
          # üèÜ Multi Benchmark Comparison Report

          <details>
          <summary>üìã Environment Details</summary>

          **Software:**
          - **Runner**: ubuntu-latest
          - **Node.js**: 22
          - **pnpm**: 9.15.0

          **Hardware:**
          - **CPU**: ${CPU_MODEL}
          - **CPU Cores**: ${CPU_CORES}
          - **Memory**: ${TOTAL_MEM}
          - **Available Disk**: ${DISK_SPACE}

          **Metadata:**
          - **Timestamp**: ${{ needs.setup-matrix.outputs.timestamp }}
          - **Git SHA**: ${{ github.sha }}
          - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          </details>

          ## üìä Configuration Comparison

          EOF

          # Generate comparison table with visual indicators
          echo "| Configuration | Cache Config | Build Mode | Setup ‚è±Ô∏è | Build ‚è±Ô∏è | Total ‚è±Ô∏è |" >> comparison-report.md
          echo "|---------------|--------------|------------|----------|----------|----------|" >> comparison-report.md

          for file in combined/*.json; do
            NAME=$(jq -r '.benchmark_name' "$file")
            PNPM=$(jq -r '.configuration.pnpm_cache' "$file")
            TURBO=$(jq -r '.configuration.turbo_cache' "$file")
            S3=$(jq -r '.configuration.s3_remote' "$file")
            S3_REGION=$(jq -r '.configuration.s3_region' "$file")
            PARALLEL=$(jq -r '.configuration.parallel_build' "$file")
            SETUP=$(jq -r '.timings.setup_total' "$file")
            BUILD=$(jq -r '.timings.build_total' "$file")
            TOTAL=$(jq -r '.timings.total' "$file")

            # Build cache configuration string
            CACHE_CONFIG=""
            [ "$PNPM" = "true" ] && CACHE_CONFIG="${CACHE_CONFIG}üì¶pnpm "
            [ "$TURBO" = "true" ] && CACHE_CONFIG="${CACHE_CONFIG}‚ö°local "
            if [ "$S3" = "true" ] && [ -n "$S3_REGION" ]; then
              CACHE_CONFIG="${CACHE_CONFIG}‚òÅÔ∏èS3-${S3_REGION} "
            fi
            [ -z "$CACHE_CONFIG" ] && CACHE_CONFIG="‚ùå none"

            # Build mode
            BUILD_MODE=$( [ "$PARALLEL" = "true" ] && echo "üîÄ parallel" || echo "‚û°Ô∏è sequential" )

            echo "| **${NAME}** | ${CACHE_CONFIG} | ${BUILD_MODE} | ${SETUP}s | ${BUILD}s | **${TOTAL}s** |" >> comparison-report.md
          done

          echo "" >> comparison-report.md
          echo "---" >> comparison-report.md
          echo "" >> comparison-report.md

          # Find baseline for comparison
          BASELINE_FILE=$(find combined -name "baseline.json" -type f | head -1)

          if [ -n "$BASELINE_FILE" ]; then
            BASELINE_TOTAL=$(jq -r '.timings.total' "$BASELINE_FILE")
            BASELINE_SETUP=$(jq -r '.timings.setup_total' "$BASELINE_FILE")
            BASELINE_BUILD=$(jq -r '.timings.build_total' "$BASELINE_FILE")

            echo "## üìà Performance Improvement vs Baseline" >> comparison-report.md
            echo "" >> comparison-report.md
            echo "| Configuration | Total Time | Improvement | Setup Œî | Build Œî | Time Saved |" >> comparison-report.md
            echo "|---------------|------------|-------------|---------|---------|------------|" >> comparison-report.md

            # Add baseline row first
            echo "| **baseline** | ${BASELINE_TOTAL}s | - | - | - | - |" >> comparison-report.md

            for file in combined/*.json; do
              NAME=$(jq -r '.benchmark_name' "$file")

              if [ "$NAME" != "baseline" ]; then
                TOTAL=$(jq -r '.timings.total' "$file")
                SETUP=$(jq -r '.timings.setup_total' "$file")
                BUILD=$(jq -r '.timings.build_total' "$file")

                TOTAL_CHANGE=$(echo "scale=1; (($TOTAL - $BASELINE_TOTAL) / $BASELINE_TOTAL) * 100" | bc)
                SETUP_CHANGE=$(echo "scale=1; (($SETUP - $BASELINE_SETUP) / $BASELINE_SETUP) * 100" | bc)
                BUILD_CHANGE=$(echo "scale=1; (($BUILD - $BASELINE_BUILD) / $BASELINE_BUILD) * 100" | bc)
                TIME_SAVED=$(echo "scale=2; $BASELINE_TOTAL - $TOTAL" | bc)

                # Add visual indicator for improvement/regression
                if (( $(echo "$TOTAL_CHANGE < 0" | bc) )); then
                  INDICATOR="üü¢"
                  CHANGE_TEXT="**${TOTAL_CHANGE}%**"
                else
                  INDICATOR="üî¥"
                  CHANGE_TEXT="${TOTAL_CHANGE}%"
                fi

                echo "| **${NAME}** | ${TOTAL}s | ${INDICATOR} ${CHANGE_TEXT} | ${SETUP_CHANGE}% | ${BUILD_CHANGE}% | **${TIME_SAVED}s** |" >> comparison-report.md
              fi
            done

            echo "" >> comparison-report.md
            echo "---" >> comparison-report.md
            echo "" >> comparison-report.md

            # Find best configuration (lowest total time)
            BEST_TIME=$(find combined -name "*.json" -type f -exec jq -r '.timings.total' {} + | sort -n | head -1)
            BEST_CONFIG=$(find combined -name "*.json" -type f | while read f; do
              if [ "$(jq -r .timings.total "$f")" = "$BEST_TIME" ]; then
                jq -r .benchmark_name "$f"
                break
              fi
            done)

            # Find worst configuration (highest total time, excluding baseline)
            WORST_TIME=$(find combined -name "*.json" -type f | while read f; do
              NAME=$(jq -r .benchmark_name "$f")
              if [ "$NAME" != "baseline" ]; then
                jq -r .timings.total "$f"
              fi
            done | sort -n | tail -1)

            # Calculate improvement percentage
            BEST_IMPROVEMENT=$(echo "scale=1; (($BASELINE_TOTAL - $BEST_TIME) / $BASELINE_TOTAL) * 100" | bc)
            BEST_TIME_SAVED=$(echo "scale=2; $BASELINE_TOTAL - $BEST_TIME" | bc)

            echo "## üéØ Summary & Recommendations" >> comparison-report.md
            echo "" >> comparison-report.md
            echo "> üèÜ **Best Configuration**: \`${BEST_CONFIG}\` (${BEST_TIME}s)" >> comparison-report.md
            echo "> " >> comparison-report.md
            echo "> üìä **Improvement**: ${BEST_IMPROVEMENT}% faster than baseline" >> comparison-report.md
            echo "> " >> comparison-report.md
            echo "> ‚ö° **Time Saved**: ${BEST_TIME_SAVED}s per build" >> comparison-report.md
            echo "" >> comparison-report.md

            # Provide insights based on results
            echo "### üí° Key Insights" >> comparison-report.md
            echo "" >> comparison-report.md

            # Check which optimizations provided the most benefit
            PNPM_ONLY=$(find combined -name "with-pnpm-cache.json" -type f | head -1)
            TURBO_ONLY=$(find combined -name "with-turbo-cache.json" -type f | head -1)
            S3_APNE2=$(find combined -name "with-s3-apne2.json" -type f | head -1)
            S3_USEA1=$(find combined -name "with-s3-usea1.json" -type f | head -1)
            PARALLEL_ONLY=$(find combined -name "parallel-builds.json" -type f | head -1)

            if [ -n "$PNPM_ONLY" ]; then
              PNPM_TIME=$(jq -r '.timings.total' "$PNPM_ONLY")
              PNPM_IMPROVE=$(echo "scale=1; (($BASELINE_TOTAL - $PNPM_TIME) / $BASELINE_TOTAL) * 100" | bc)
              echo "- **pnpm Cache**: ${PNPM_IMPROVE}% improvement in total time" >> comparison-report.md
            fi

            if [ -n "$TURBO_ONLY" ]; then
              TURBO_TIME=$(jq -r '.timings.total' "$TURBO_ONLY")
              TURBO_IMPROVE=$(echo "scale=1; (($BASELINE_TOTAL - $TURBO_TIME) / $BASELINE_TOTAL) * 100" | bc)
              echo "- **Turbo Local Cache**: ${TURBO_IMPROVE}% improvement in total time" >> comparison-report.md
            fi

            if [ -n "$S3_APNE2" ]; then
              S3_APNE2_TIME=$(jq -r '.timings.total' "$S3_APNE2")
              S3_APNE2_IMPROVE=$(echo "scale=1; (($BASELINE_TOTAL - $S3_APNE2_TIME) / $BASELINE_TOTAL) * 100" | bc)
              echo "- **S3 Remote Cache (ap-northeast-2)**: ${S3_APNE2_IMPROVE}% improvement in total time" >> comparison-report.md
            fi

            if [ -n "$S3_USEA1" ]; then
              S3_USEA1_TIME=$(jq -r '.timings.total' "$S3_USEA1")
              S3_USEA1_IMPROVE=$(echo "scale=1; (($BASELINE_TOTAL - $S3_USEA1_TIME) / $BASELINE_TOTAL) * 100" | bc)
              echo "- **S3 Remote Cache (us-east-1)**: ${S3_USEA1_IMPROVE}% improvement in total time" >> comparison-report.md
            fi

            if [ -n "$PARALLEL_ONLY" ]; then
              PARALLEL_TIME=$(jq -r '.timings.total' "$PARALLEL_ONLY")
              PARALLEL_IMPROVE=$(echo "scale=1; (($BASELINE_TOTAL - $PARALLEL_TIME) / $BASELINE_TOTAL) * 100" | bc)
              echo "- **Parallel Builds**: ${PARALLEL_IMPROVE}% improvement in total time" >> comparison-report.md
            fi

            # S3 region comparison
            if [ -n "$S3_APNE2" ] && [ -n "$S3_USEA1" ]; then
              REGION_DIFF=$(echo "scale=1; (($S3_USEA1_TIME - $S3_APNE2_TIME) / $S3_APNE2_TIME) * 100" | bc)
              if (( $(echo "$REGION_DIFF > 0" | bc) )); then
                echo "" >> comparison-report.md
                echo "**Region Impact**: ap-northeast-2 is ${REGION_DIFF}% faster than us-east-1 (closer to runner location)" >> comparison-report.md
              elif (( $(echo "$REGION_DIFF < 0" | bc) )); then
                REGION_DIFF_ABS=$(echo "scale=1; -1 * $REGION_DIFF" | bc)
                echo "" >> comparison-report.md
                echo "**Region Impact**: us-east-1 is ${REGION_DIFF_ABS}% faster than ap-northeast-2" >> comparison-report.md
              fi
            fi

            echo "" >> comparison-report.md
            echo "### üìä Visual Performance Comparison" >> comparison-report.md
            echo "" >> comparison-report.md
            echo "\`\`\`" >> comparison-report.md
            echo "Relative Performance (lower is better):" >> comparison-report.md
            echo "" >> comparison-report.md

            # Create visual bars for each configuration
            for file in combined/*.json; do
              NAME=$(jq -r '.benchmark_name' "$file")
              TOTAL=$(jq -r '.timings.total' "$file")

              # Calculate percentage relative to baseline (multiply first, then truncate)
              PERCENT=$(echo "scale=2; $TOTAL * 100 / $BASELINE_TOTAL" | bc | cut -d. -f1)

              # Create bar (each # = 2%)
              BAR_LENGTH=$((PERCENT / 2))
              BAR=$(printf '%*s' "$BAR_LENGTH" | tr ' ' '‚ñà')

              # Format the line with padding
              printf "%-25s %3d%% %s\n" "$NAME" "$PERCENT" "$BAR" >> comparison-report.md
            done

            echo "\`\`\`" >> comparison-report.md
            echo "" >> comparison-report.md

            echo "### üöÄ Next Steps" >> comparison-report.md
            echo "" >> comparison-report.md
            echo "1. Review the detailed breakdown above to identify bottlenecks" >> comparison-report.md
            echo "2. Consider adopting the \`${BEST_CONFIG}\` configuration for CI/CD" >> comparison-report.md
            echo "3. Monitor cache hit rates to ensure optimal performance" >> comparison-report.md
            echo "4. Re-run benchmarks periodically to track performance over time" >> comparison-report.md
            echo "" >> comparison-report.md
          fi

          # Save report
          cat comparison-report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Create comparison artifact
        run: |
          cat > comparison-summary.json << EOF
          {
            "timestamp": "${{ needs.setup-matrix.outputs.timestamp }}",
            "configuration_set": "${{ github.event.inputs.configurations }}",
            "results": $(find combined -name "*.json" -type f -exec cat {} \; | jq -s '.'),
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report-${{ needs.setup-matrix.outputs.timestamp }}
          path: |
            comparison-report.md
            comparison-summary.json
            combined/
          retention-days: 90

      - name: Add final summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'

          ---

          ## ‚úÖ Benchmark Comparison Complete

          ### üì¶ Artifacts Generated

          - **Individual Results**: `benchmark-{config-name}` - Raw timing data for each configuration
          - **Comparison Report**: `comparison-report-${{ needs.setup-matrix.outputs.timestamp }}` - Full analysis with insights

          ### üìä Artifact Contents

          Each artifact includes:
          - `*.json` - Machine-readable benchmark data
          - `comparison-report.md` - Formatted comparison report
          - `comparison-summary.json` - Aggregated results

          ### üîó Quick Links

          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - [Branch](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }})

          ---

          *Generated by Multi Benchmark Comparison workflow*

          EOF
