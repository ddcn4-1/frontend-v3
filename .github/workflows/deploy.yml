name: Deploy Frontend

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CLIENT_BUCKET_NAME: ${{ vars.CLIENT_BUCKET_NAME }}
  ADMIN_BUCKET_NAME: ${{ vars.ADMIN_BUCKET_NAME }}
  ACCOUNTS_BUCKET_NAME: ${{ vars.ACCOUNTS_BUCKET_NAME }}
  AWS_REGION: ap-northeast-2

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
  
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0
        
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: build client
        run: pnpm run build
        working-directory: ./apps/client

      - name: build admin
        run: pnpm run build
        working-directory: ./apps/admin
        
      - name: build accounts
        run: pnpm run build
        working-directory: ./apps/accounts

      - name: Build client artifact upload
        uses: actions/upload-artifact@v4
        with:
          name: build-client-frontend-files
          path: ./apps/client/dist
          retention-days: 1
          
      - name: Build admin artifact upload
        uses: actions/upload-artifact@v4
        with:
          name: build-admin-frontend-files
          path: ./apps/admin/dist
          retention-days: 1
          
      - name: Build accounts artifact upload
        uses: actions/upload-artifact@v4
        with:
          name: build-accounts-frontend-files
          path: ./apps/accounts/dist
          retention-days: 1
          
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build client artifact download
        uses: actions/download-artifact@v4
        with:
          name: build-client-frontend-files
          path: build/client
          
      - name: Build admin artifact download
        uses: actions/download-artifact@v4
        with:
          name: build-admin-frontend-files
          path: build/admin
          
      - name: Build accounts artifact download
        uses: actions/download-artifact@v4
        with:
          name: build-accounts-frontend-files
          path: build/accounts

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: S3 client Upload
        run: |
          echo "â±ï¸ Starting client upload..."
          START_TIME=$(date +%s)
          FILE_COUNT=$(find ./build/client -type f | wc -l)
          TOTAL_SIZE=$(du -sb ./build/client | cut -f1)

          aws s3 sync ./build/client s3://${{ env.CLIENT_BUCKET_NAME }} \
            --delete \
            --exact-timestamps

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          SPEED=$((TOTAL_SIZE / DURATION / 1024))

          echo "client_upload_duration=${DURATION}" >> $GITHUB_ENV
          echo "client_file_count=${FILE_COUNT}" >> $GITHUB_ENV
          echo "client_total_size=${TOTAL_SIZE}" >> $GITHUB_ENV
          echo "client_upload_speed=${SPEED}" >> $GITHUB_ENV

          echo "âœ… Client upload completed in ${DURATION}s (${FILE_COUNT} files, $(numfmt --to=iec ${TOTAL_SIZE}), ${SPEED} KB/s)"

      - name: S3 admin Upload
        run: |
          echo "â±ï¸ Starting admin upload..."
          START_TIME=$(date +%s)
          FILE_COUNT=$(find ./build/admin -type f | wc -l)
          TOTAL_SIZE=$(du -sb ./build/admin | cut -f1)

          aws s3 sync ./build/admin s3://${{ env.ADMIN_BUCKET_NAME }} \
            --delete \
            --exact-timestamps

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          SPEED=$((TOTAL_SIZE / DURATION / 1024))

          echo "admin_upload_duration=${DURATION}" >> $GITHUB_ENV
          echo "admin_file_count=${FILE_COUNT}" >> $GITHUB_ENV
          echo "admin_total_size=${TOTAL_SIZE}" >> $GITHUB_ENV
          echo "admin_upload_speed=${SPEED}" >> $GITHUB_ENV

          echo "âœ… Admin upload completed in ${DURATION}s (${FILE_COUNT} files, $(numfmt --to=iec ${TOTAL_SIZE}), ${SPEED} KB/s)"

      - name: S3 accounts Upload
        run: |
          echo "â±ï¸ Starting accounts upload..."
          START_TIME=$(date +%s)
          FILE_COUNT=$(find ./build/accounts -type f | wc -l)
          TOTAL_SIZE=$(du -sb ./build/accounts | cut -f1)

          aws s3 sync ./build/accounts s3://${{ env.ACCOUNTS_BUCKET_NAME }} \
            --delete \
            --exact-timestamps

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          SPEED=$((TOTAL_SIZE / DURATION / 1024))

          echo "accounts_upload_duration=${DURATION}" >> $GITHUB_ENV
          echo "accounts_file_count=${FILE_COUNT}" >> $GITHUB_ENV
          echo "accounts_total_size=${TOTAL_SIZE}" >> $GITHUB_ENV
          echo "accounts_upload_speed=${SPEED}" >> $GITHUB_ENV

          echo "âœ… Accounts upload completed in ${DURATION}s (${FILE_COUNT} files, $(numfmt --to=iec ${TOTAL_SIZE}), ${SPEED} KB/s)"

      - name: Generate Deployment Summary
        run: |
          TOTAL_UPLOAD_TIME=$((client_upload_duration + admin_upload_duration + accounts_upload_duration))
          TOTAL_FILES=$((client_file_count + admin_file_count + accounts_file_count))
          TOTAL_SIZE=$((client_total_size + admin_total_size + accounts_total_size))

          echo "## ðŸ“¦ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### S3 Upload Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Application | Duration | Files | Size | Speed |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------|-------|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Client | ${client_upload_duration}s | ${client_file_count} | $(numfmt --to=iec ${client_total_size}) | ${client_upload_speed} KB/s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ› ï¸ Admin | ${admin_upload_duration}s | ${admin_file_count} | $(numfmt --to=iec ${admin_total_size}) | ${admin_upload_speed} KB/s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Accounts | ${accounts_upload_duration}s | ${accounts_file_count} | $(numfmt --to=iec ${accounts_total_size}) | ${accounts_upload_speed} KB/s |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${TOTAL_UPLOAD_TIME}s** | **${TOTAL_FILES}** | **$(numfmt --to=iec ${TOTAL_SIZE})** | **-** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Deployment Targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Client Bucket**: \`${{ env.CLIENT_BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Bucket**: \`${{ env.ADMIN_BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Accounts Bucket**: \`${{ env.ACCOUNTS_BUCKET_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
